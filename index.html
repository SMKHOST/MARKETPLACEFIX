<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Diponegoro Marketplace</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Firebase SDK - Modular SDK -->
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js",
        "firebase/storage": "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js",
        "firebase/analytics": "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js"
      }
    }
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      background-color: #f0f2f5;
      color: #050505;
      line-height: 1.6;
      overflow-x: hidden;
      touch-action: manipulation;
    }

    /* Login Page Styles */
    .background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('https://files.catbox.moe/ll5y61.png');
      background-size: cover;
      background-position: center;
      filter: brightness(0.8);
      z-index: -1;
    }

    .container {
      width: 100%;
      max-width: 400px;
      padding: 20px;
      z-index: 1;
      margin: 80px auto 0;
    }

    @media (max-width: 480px) {
      .container {
        padding: 15px;
        max-width: 100%;
        margin-top: 40px;
      }
    }

    .glass-card {
      backdrop-filter: blur(18px);
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 30px 25px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      color: white;
      animation: fadeInUp 1.2s ease-out;
    }

    @media (max-width: 480px) {
      .glass-card {
        padding: 20px 15px;
        border-radius: 15px;
      }
    }

    .glass-card h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
    }

    .glass-card p {
      font-size: 14px;
      margin-bottom: 25px;
      opacity: 0.8;
      text-align: center;
    }

    .glass-card label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .glass-card input {
      width: 100%;
      padding: 12px 14px;
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      color: white;
      transition: border-color 0.3s;
      -webkit-appearance: none;
    }

    .glass-card input:focus {
      border-color: rgba(255, 255, 255, 0.5);
    }

    .glass-card input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .glass-card button {
      width: 100%;
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s ease;
      font-weight: 600;
      touch-action: manipulation;
    }

    .glass-card button:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }

    .glass-card button:active {
      transform: scale(0.98);
    }

    .footer {
      margin-top: 20px;
      text-align: center;
      font-size: 14px;
    }

    .footer a {
      color: #fff;
      text-decoration: underline;
      font-weight: 500;
      cursor: pointer;
    }

    .footer a:hover {
      opacity: 0.8;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Error message */
    .error-message {
      background-color: rgba(255, 50, 50, 0.2);
      border: 1px solid rgba(255, 100, 100, 0.5);
      color: #ffcccc;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
      text-align: center;
    }

    /* Success message */
    .success-message {
      background-color: rgba(50, 255, 50, 0.2);
      border: 1px solid rgba(100, 255, 100, 0.5);
      color: #ccffcc;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
      text-align: center;
    }

    /* Register page styles */
    .register-card {
      display: none;
    }

    /* Tabs */
    .form-tabs {
      display: flex;
      margin-bottom: 25px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 12px 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      font-size: 15px;
    }

    .tab.active {
      border-bottom: 3px solid white;
      color: white;
    }

    .tab:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Form row for mobile */
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    @media (max-width: 480px) {
      .form-row {
        flex-direction: column;
        gap: 0;
      }
    }

    /* Password Strength Indicator */
    .password-strength {
      margin-top: -10px;
      margin-bottom: 20px;
      height: 5px;
      border-radius: 3px;
      background-color: #e0e0e0;
      overflow: hidden;
    }

    .password-strength-bar {
      height: 100%;
      width: 0%;
      transition: width 0.3s, background-color 0.3s;
    }

    .password-strength.weak .password-strength-bar {
      width: 33%;
      background-color: #ff4444;
    }

    .password-strength.medium .password-strength-bar {
      width: 66%;
      background-color: #ffbb33;
    }

    .password-strength.strong .password-strength-bar {
      width: 100%;
      background-color: #00C851;
    }

    /* Marketplace Variables */
    :root {
      --primary-color: #1877f2;
      --secondary-color: #42b72a;
      --danger-color: #e41e3f;
      --warning-color: #ff6b6b;
      --bg-color: #f0f2f5;
      --card-color: #ffffff;
      --text-primary: #050505;
      --text-secondary: #65676b;
      --border-color: #dddfe2;
      --online-status: #31a24c;
      --hover-color: #f2f2f2;
      --admin-color: #8a2be2;
      --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Marketplace Container */
    .marketplace-container {
      display: none;
      min-height: 100vh;
      background-color: var(--bg-color);
    }

    /* Header/Navbar */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: var(--card-color);
      box-shadow: var(--shadow);
      z-index: 1000;
      padding: 10px 0;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }

    @media (max-width: 768px) {
      .navbar {
        padding: 0 10px;
      }
    }

    .logo {
      display: flex;
      align-items: center;
      font-size: 20px;
      font-weight: bold;
      color: var(--primary-color);
      gap: 10px;
      text-decoration: none;
    }

    .logo-img {
      height: 35px;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .logo-text {
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(135deg, #1877f2, #42b72a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    @media (max-width: 480px) {
      .logo-text {
        display: none;
      }
    }

    .nav-links {
      display: flex;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .nav-links {
        gap: 10px;
      }
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .nav-item {
        padding: 8px;
      }
      
      .nav-item span {
        font-size: 11px;
      }
    }

    .nav-item:hover {
      background-color: var(--hover-color);
    }

    .nav-item.active {
      color: var(--primary-color);
      border-bottom: 3px solid var(--primary-color);
    }

    .nav-item i {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .nav-item.admin-badge {
      color: var(--admin-color);
      border-color: var(--admin-color);
    }

    .user-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .notification {
      position: relative;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }

    .notification:hover {
      background-color: var(--hover-color);
    }

    .notification-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: var(--danger-color);
      color: white;
      font-size: 10px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .user-profile {
      position: relative;
      cursor: pointer;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s;
    }

    .user-avatar:hover {
      border-color: var(--primary-color);
    }

    .user-avatar.admin {
      border-color: var(--admin-color);
    }

    .profile-dropdown {
      position: absolute;
      top: 50px;
      right: 0;
      background-color: var(--card-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-radius: 8px;
      width: 250px;
      z-index: 1001;
      display: none;
      overflow: hidden;
    }

    .profile-dropdown.active {
      display: block;
      animation: fadeIn 0.2s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dropdown-header {
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
    }

    .dropdown-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }

    .dropdown-user-info h4 {
      font-size: 15px;
      margin-bottom: 2px;
    }

    .dropdown-user-info p {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .dropdown-menu {
      list-style: none;
      max-height: 300px;
      overflow-y: auto;
    }

    .dropdown-item {
      padding: 12px 15px;
      display: flex;
      align-items: center;
      transition: background-color 0.2s;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      text-decoration: none;
      color: var(--text-primary);
    }

    .dropdown-item:hover {
      background-color: var(--hover-color);
    }

    .dropdown-item i {
      width: 20px;
      margin-right: 10px;
      color: var(--text-secondary);
    }

    .dropdown-item.logout {
      color: var(--danger-color);
    }

    .dropdown-item.logout i {
      color: var(--danger-color);
    }

    /* Notification Dropdown */
    .notification-dropdown {
      position: absolute;
      top: 50px;
      right: 45px;
      background-color: var(--card-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-radius: 8px;
      width: 350px;
      max-height: 400px;
      z-index: 1001;
      display: none;
      overflow: hidden;
    }

    @media (max-width: 480px) {
      .notification-dropdown {
        width: 300px;
        right: 10px;
      }
    }

    .notification-dropdown.active {
      display: block;
      animation: fadeIn 0.2s;
    }

    .notification-header {
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notification-header h3 {
      font-size: 16px;
      color: var(--text-primary);
    }

    .mark-all-read {
      background: none;
      border: none;
      color: var(--primary-color);
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }

    .notification-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: flex-start;
    }

    .notification-item:hover {
      background-color: var(--hover-color);
    }

    .notification-item.unread {
      background-color: rgba(24, 119, 242, 0.05);
    }

    .notification-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .notification-icon.message {
      background-color: rgba(24, 119, 242, 0.1);
      color: var(--primary-color);
    }

    .notification-icon.like {
      background-color: rgba(255, 107, 107, 0.1);
      color: var(--danger-color);
    }

    .notification-icon.comment {
      background-color: rgba(66, 183, 42, 0.1);
      color: var(--secondary-color);
    }

    .notification-icon.order {
      background-color: rgba(138, 43, 226, 0.1);
      color: var(--admin-color);
    }

    .notification-content {
      flex: 1;
    }

    .notification-text {
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 5px;
    }

    .notification-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .notification-item.unread .notification-text {
      font-weight: 600;
    }

    /* Main content */
    .container-marketplace {
      max-width: 1200px;
      margin: 0 auto;
      padding-top: 70px;
      padding-bottom: 20px;
    }

    @media (max-width: 1200px) {
      .container-marketplace {
        padding-left: 15px;
        padding-right: 15px;
      }
    }

    .main-content {
      min-height: calc(100vh - 100px);
      width: 100%;
    }

    .content-section {
      display: none;
      animation: fadeIn 0.5s;
    }

    .content-section.active {
      display: block;
    }

    .section-title {
      font-size: 24px;
      margin-bottom: 20px;
      color: var(--text-primary);
    }

    @media (max-width: 768px) {
      .section-title {
        font-size: 20px;
      }
    }

    /* Marketplace Section */
    .marketplace-header {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    @media (min-width: 768px) {
      .marketplace-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
    }

    .search-bar {
      display: flex;
      align-items: center;
      background-color: var(--card-color);
      border-radius: 20px;
      padding: 8px 15px;
      width: 100%;
      max-width: 400px;
    }

    .search-bar i {
      color: var(--text-secondary);
    }

    .search-bar input {
      border: none;
      outline: none;
      background: transparent;
      width: 100%;
      margin-left: 10px;
      font-size: 16px;
    }

    .categories {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 10px;
      -webkit-overflow-scrolling: touch;
    }

    .category {
      padding: 8px 15px;
      background-color: var(--card-color);
      border-radius: 20px;
      cursor: pointer;
      white-space: nowrap;
      transition: background-color 0.2s;
      font-size: 14px;
    }

    .category:hover {
      background-color: var(--hover-color);
    }

    .category.active {
      background-color: var(--primary-color);
      color: white;
    }

    .add-product-btn {
      background-color: var(--secondary-color);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background-color 0.2s;
      font-size: 16px;
      touch-action: manipulation;
    }

    .add-product-btn:hover {
      background-color: #36a420;
    }

    .add-product-btn:active {
      transform: scale(0.98);
    }

    /* Products Grid */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      min-height: 300px;
    }

    @media (max-width: 1024px) {
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
      }
    }

    @media (max-width: 768px) {
      .products-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
    }

    @media (max-width: 480px) {
      .products-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
    }

    .product-card {
      background-color: var(--card-color);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: transform 0.2s;
      cursor: pointer;
      display: flex;
      flex-direction: column;
    }

    .product-card:hover {
      transform: translateY(-5px);
    }

    .product-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }

    @media (max-width: 768px) {
      .product-image {
        height: 150px;
      }
    }

    .product-info {
      padding: 15px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 480px) {
      .product-info {
        padding: 10px;
      }
    }

    .product-title {
      font-weight: 600;
      margin-bottom: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      min-height: 40px;
      font-size: 14px;
    }

    @media (max-width: 480px) {
      .product-title {
        font-size: 13px;
        min-height: 35px;
        margin-bottom: 5px;
      }
    }

    .product-price {
      color: var(--primary-color);
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 18px;
    }

    @media (max-width: 480px) {
      .product-price {
        font-size: 15px;
        margin-bottom: 8px;
      }
    }

    .product-seller {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .seller-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 8px;
    }

    .seller-name {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .product-actions {
      display: flex;
      gap: 10px;
      margin-top: auto;
    }

    .btn {
      padding: 10px 15px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
      font-size: 14px;
      touch-action: manipulation;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 12px;
    }

    @media (max-width: 480px) {
      .btn {
        padding: 8px 10px;
        font-size: 12px;
      }
      .btn-sm {
        padding: 6px 8px;
        font-size: 11px;
      }
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: #166fe5;
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background-color: #36a420;
    }

    .btn-danger {
      background-color: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background-color: #d11a3a;
    }

    .btn-warning {
      background-color: var(--warning-color);
      color: white;
    }

    .btn-warning:hover {
      background-color: #ff5252;
    }

    .btn-admin {
      background-color: var(--admin-color);
      color: white;
    }

    .btn-admin:hover {
      background-color: #7b1fa2;
    }

    .back-btn {
      background-color: var(--text-secondary);
      color: white;
    }

    .back-btn:hover {
      background-color: #555;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      grid-column: 1 / -1;
    }

    .empty-state i {
      font-size: 64px;
      margin-bottom: 20px;
      color: var(--border-color);
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .empty-state p {
      max-width: 500px;
      margin: 0 auto 20px;
      line-height: 1.6;
    }

    /* Settings Section */
    .settings-container {
      background-color: var(--card-color);
      border-radius: 10px;
      padding: 30px;
      box-shadow: var(--shadow);
    }

    @media (max-width: 768px) {
      .settings-container {
        padding: 20px;
      }
    }

    .settings-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 30px;
      overflow-x: auto;
    }

    .settings-tab {
      padding: 15px 20px;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 3px solid transparent;
      white-space: nowrap;
    }

    .settings-tab:hover {
      color: var(--primary-color);
    }

    .settings-tab.active {
      color: var(--primary-color);
      border-bottom: 3px solid var(--primary-color);
    }

    .settings-content {
      display: none;
    }

    .settings-content.active {
      display: block;
    }

    .settings-section {
      margin-bottom: 30px;
    }

    .settings-section h3 {
      font-size: 18px;
      margin-bottom: 20px;
      color: var(--text-primary);
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
    }

    .settings-form {
      max-width: 600px;
    }

    .settings-form .form-group {
      margin-bottom: 25px;
    }

    .settings-form label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .settings-form input,
    .settings-form textarea,
    .settings-form select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
      background-color: white;
    }

    .settings-form input:focus,
    .settings-form textarea:focus,
    .settings-form select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .settings-form textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.6;
    }

    .settings-form .form-info {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 8px;
      display: block;
    }

    /* Profile Picture Upload */
    .profile-picture-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
    }

    .profile-preview {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--border-color);
    }

    .profile-upload-options {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .upload-option-btn {
      padding: 12px 24px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background-color 0.2s;
    }

    .upload-option-btn:hover {
      background-color: #166fe5;
    }

    .upload-option-btn.camera {
      background-color: var(--secondary-color);
    }

    .upload-option-btn.camera:hover {
      background-color: #36a420;
    }

    .upload-option-btn.album {
      background-color: var(--admin-color);
    }

    .upload-option-btn.album:hover {
      background-color: #7b1fa2;
    }

    /* Product Detail */
    .product-detail-container {
      background-color: var(--card-color);
      border-radius: 10px;
      padding: 25px;
      box-shadow: var(--shadow);
    }

    @media (max-width: 768px) {
      .product-detail-container {
        padding: 15px;
      }
    }

    .product-detail {
      display: grid;
      grid-template-columns: 1fr;
      gap: 30px;
    }

    @media (min-width: 992px) {
      .product-detail {
        grid-template-columns: 1fr 1fr;
      }
    }

    .product-images {
      position: relative;
    }

    .product-images img {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .product-thumbnails {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .product-thumbnails img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 5px;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .product-thumbnails img.active {
      border-color: var(--primary-color);
    }

    .product-info-detail h1 {
      font-size: 28px;
      margin-bottom: 10px;
      line-height: 1.3;
    }

    @media (max-width: 768px) {
      .product-info-detail h1 {
        font-size: 22px;
      }
    }

    .product-price-detail {
      font-size: 28px;
      color: var(--primary-color);
      font-weight: bold;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .product-price-detail {
        font-size: 24px;
      }
    }

    .seller-info {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background-color: var(--bg-color);
      border-radius: 8px;
    }

    .seller-avatar-detail {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 15px;
    }

    .seller-info-detail h3 {
      margin-bottom: 5px;
      font-size: 18px;
    }

    .product-description {
      margin-bottom: 30px;
    }

    .product-description h3 {
      margin-bottom: 10px;
      font-size: 18px;
    }

    .product-description p {
      color: var(--text-secondary);
      line-height: 1.8;
      font-size: 16px;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 30px;
    }

    @media (min-width: 768px) {
      .action-buttons {
        flex-direction: row;
      }
    }

    /* Messages Section */
    .messages-container {
      display: flex;
      flex-direction: column;
      height: 600px;
      background-color: var(--card-color);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    @media (min-width: 768px) {
      .messages-container {
        flex-direction: row;
      }
    }

    .conversations {
      width: 100%;
      border-bottom: 1px solid var(--border-color);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 768px) {
      .conversations {
        width: 300px;
        border-right: 1px solid var(--border-color);
        border-bottom: none;
      }
    }

    .conversations-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .conversations-list {
      list-style: none;
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .conversation {
      display: flex;
      align-items: center;
      padding: 15px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s;
      position: relative;
    }

    .conversation:hover {
      background-color: var(--hover-color);
    }

    .conversation.active {
      background-color: var(--hover-color);
    }

    .conversation-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }

    .conversation-info {
      flex: 1;
      min-width: 0;
    }

    .conversation-name {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 16px;
    }

    .conversation-preview {
      font-size: 14px;
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      position: relative;
      -webkit-overflow-scrolling: touch;
    }

    .message {
      max-width: 80%;
      margin-bottom: 15px;
      padding: 12px 16px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
    }

    @media (min-width: 768px) {
      .message {
        max-width: 70%;
      }
    }

    .message.received {
      background-color: var(--border-color);
      align-self: flex-start;
    }

    .message.sent {
      background-color: var(--primary-color);
      color: white;
      align-self: flex-end;
    }

    .chat-input {
      padding: 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-input input {
      flex: 1;
      padding: 12px 15px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
      outline: none;
      font-size: 16px;
    }

    .send-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    /* Add Product Section */
    .add-product-form {
      background-color: var(--card-color);
      border-radius: 10px;
      padding: 25px;
      max-width: 800px;
      margin: 0 auto;
    }

    @media (max-width: 768px) {
      .add-product-form {
        padding: 20px;
      }
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary);
    }

    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
      background-color: white;
    }

    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.6;
    }

    .image-upload {
      border: 2px dashed var(--border-color);
      border-radius: 10px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background-color: var(--bg-color);
    }

    .image-upload:hover {
      border-color: var(--primary-color);
      background-color: #f8f9fa;
    }

    .image-upload i {
      font-size: 48px;
      color: var(--text-secondary);
      margin-bottom: 15px;
    }

    .image-upload p {
      color: var(--text-secondary);
      margin-bottom: 5px;
    }

    .uploaded-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .uploaded-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      position: relative;
    }

    .remove-image {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: rgba(0,0,0,0.7);
      color: white;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .remove-image:hover {
      background-color: rgba(0,0,0,0.9);
    }

    /* Admin Panel */
    .admin-panel {
      background-color: var(--card-color);
      border-radius: 10px;
      padding: 25px;
      box-shadow: var(--shadow);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary-color), #4a6fa5);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-card h4 {
      font-size: 14px;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .stat-card .stat-number {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-card.warning {
      background: linear-gradient(135deg, var(--warning-color), #ff9800);
    }

    .stat-card.admin {
      background: linear-gradient(135deg, var(--admin-color), #7b1fa2);
    }

    .stat-card.success {
      background: linear-gradient(135deg, var(--secondary-color), #388e3c);
    }

    .admin-table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--card-color);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .admin-table th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      text-align: left;
      padding: 15px;
      font-size: 14px;
    }

    .admin-table td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
    }

    .admin-table tr:hover {
      background-color: var(--hover-color);
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge.active {
      background-color: #d4edda;
      color: #155724;
    }

    .status-badge.blocked {
      background-color: #f8d7da;
      color: #721c24;
    }

    .status-badge.admin {
      background-color: #e8daef;
      color: var(--admin-color);
    }

    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      margin-right: 5px;
    }

    .action-btn.block {
      background-color: #ff6b6b;
      color: white;
    }

    .action-btn.unblock {
      background-color: #42b72a;
      color: white;
    }

    .action-btn.delete {
      background-color: #dc3545;
      color: white;
    }

    .action-btn.promote {
      background-color: #8a2be2;
      color: white;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 20px;
      -webkit-overflow-scrolling: touch;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background-color: var(--card-color);
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: modalFadeIn 0.3s;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 20px;
      color: var(--text-primary);
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 20px;
      color: var(--text-secondary);
      font-size: 14px;
      margin-top: 40px;
      border-top: 1px solid var(--border-color);
    }

    /* Camera Modal */
    #camera-preview {
      width: 100%;
      max-height: 300px;
      background: #000;
      border-radius: 8px;
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    /* Safe area for iPhone */
    @supports (padding: max(0px)) {
      .navbar {
        padding-left: max(15px, env(safe-area-inset-left));
        padding-right: max(15px, env(safe-area-inset-right));
      }
      
      .container-marketplace {
        padding-left: max(15px, env(safe-area-inset-left));
        padding-right: max(15px, env(safe-area-inset-right));
      }
    }
  </style>
</head>
<body>
  <div class="background" id="background"></div>
  
  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>
  
  <!-- Login Container -->
  <div class="container" id="loginContainer">
    <!-- Login Form -->
    <div class="glass-card login-card" id="loginCard">
      <div class="form-tabs">
        <div class="tab active" id="loginTab">Login</div>
        <div class="tab" id="registerTab">Register</div>
      </div>
      <h2>Welcome to Diponegoro Market</h2>
      <p>Please login to your account</p>
      
      <div class="error-message" id="errorMessage"></div>
      
      <div class="success-message" id="successMessage"></div>
      
      <form id="loginForm">
        <label for="username">Email</label>
        <input type="email" id="username" placeholder="email@example.com" required />
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Enter password" required />
        <button type="submit">Login</button>
        <div class="footer">
          <p style="font-size: 13px; opacity: 0.9; margin-top: 15px;">
            Gunakan akun yang sudah terdaftar
          </p>
        </div>
      </form>
    </div>
    
    <!-- Register Form -->
    <div class="glass-card register-card" id="registerCard">
      <div class="form-tabs">
        <div class="tab" id="loginTab2">Login</div>
        <div class="tab active" id="registerTab2">Register</div>
      </div>
      <h2>Create Account</h2>
      <p>Join Diponegoro Marketplace</p>
      
      <div class="error-message" id="registerErrorMessage"></div>
      <div class="success-message" id="registerSuccessMessage"></div>
      
      <form id="registerForm">
        <div class="form-row">
          <div style="flex: 1;">
            <label for="firstName">First Name *</label>
            <input type="text" id="firstName" placeholder="John" required />
          </div>
          <div style="flex: 1;">
            <label for="lastName">Last Name *</label>
            <input type="text" id="lastName" placeholder="Doe" required />
          </div>
        </div>
        
        <label for="usernameReg">Username *</label>
        <input type="text" id="usernameReg" placeholder="johndoe" required />
        <small style="display: block; margin-top: -15px; margin-bottom: 20px; font-size: 12px; opacity: 0.7;">Unique username for profile</small>
        
        <label for="nickname">Nickname</label>
        <input type="text" id="nickname" placeholder="John" />
        
        <label for="regEmail">Email *</label>
        <input type="email" id="regEmail" placeholder="email@example.com" required />
        
        <label for="regPassword">Password *</label>
        <input type="password" id="regPassword" placeholder="Minimum 6 characters" required />
        <div class="password-strength" id="passwordStrength">
          <div class="password-strength-bar"></div>
        </div>
        
        <label for="confirmPassword">Confirm Password *</label>
        <input type="password" id="confirmPassword" placeholder="Re-enter password" required />
        
        <label for="phone">Phone Number (Optional)</label>
        <input type="tel" id="phone" placeholder="08123456789" />
        
        <button type="submit">Create Account</button>
        <div class="footer">
          <p>Already have an account? <a id="backToLogin">Login here</a></p>
        </div>
      </form>
    </div>
  </div>

  <!-- Marketplace Container -->
  <div id="marketplaceContainer" class="marketplace-container">
    <!-- Marketplace content will be injected via JavaScript -->
  </div>

  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirmation-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-title">Confirmation</h3>
        <button class="close-modal" id="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <p id="modal-message">Are you sure?</p>
      </div>
      <div class="modal-footer">
        <button class="btn" id="modal-cancel">Cancel</button>
        <button class="btn btn-primary" id="modal-confirm">Yes</button>
      </div>
    </div>
  </div>

  <!-- Camera Modal -->
  <div class="modal-overlay" id="camera-modal">
    <div class="modal">
      <div class="modal-header">
        <h3>Take Photo</h3>
        <button class="close-modal" id="close-camera-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div style="text-align: center;">
          <video id="camera-preview" autoplay playsinline style="width: 100%; max-height: 300px; background: #000; border-radius: 8px;"></video>
          <canvas id="camera-canvas" style="display: none;"></canvas>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="cancel-camera">Cancel</button>
        <button class="btn btn-secondary" id="switch-camera">Switch Camera</button>
        <button class="btn btn-primary" id="capture-photo">Capture</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'firebase/app';
    import { getAnalytics } from 'firebase/analytics';
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      createUserWithEmailAndPassword, 
      onAuthStateChanged, 
      signOut, 
      updateProfile 
    } from 'firebase/auth';
    import { 
      getDatabase, 
      ref, 
      set, 
      get, 
      push, 
      onValue, 
      query, 
      orderByChild, 
      equalTo, 
      update,
      remove
    } from 'firebase/database';
    import { 
      getStorage, 
      ref as storageRef, 
      uploadBytesResumable, 
      getDownloadURL 
    } from 'firebase/storage';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBCJZsfJMDRwJmmV870t5H14w8dKKeu2Wk",
      authDomain: "marketplace-9cc96.firebaseapp.com",
      databaseURL: "https://marketplace-9cc96-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "marketplace-9cc96",
      storageBucket: "marketplace-9cc96.firebasestorage.app",
      messagingSenderId: "1082835231635",
      appId: "1:1082835231635:web:123e8d75f1c54592acbe66",
      measurementId: "G-NDR733571E"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const storage = getStorage(app);

    console.log('✅ Firebase initialized successfully');

    // ============= GLOBAL VARIABLES =============
    let currentUser = null;
    let currentUserData = null;
    let selectedImages = [];
    let products = [];
    let users = [];
    let conversations = [];
    let notifications = [];
    let notificationListener = null;
    let cameraStream = null;
    let currentFacingMode = 'user';

    // DOM Elements
    const loginContainer = document.getElementById('loginContainer');
    const marketplaceContainer = document.getElementById('marketplaceContainer');
    const loadingOverlay = document.getElementById('loadingOverlay');

    // ============= UTILITY FUNCTIONS =============
    function showLoading() {
      if (loadingOverlay) loadingOverlay.style.display = 'flex';
    }

    function hideLoading() {
      if (loadingOverlay) loadingOverlay.style.display = 'none';
    }

    function showError(message) {
      alert('❌ ' + message);
    }

    function showSuccess(message) {
      alert('✅ ' + message);
    }

    function formatTime(timestamp) {
      const now = new Date();
      const date = new Date(timestamp);
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 60) {
        return `${diffMins} minutes ago`;
      } else if (diffHours < 24) {
        return `${diffHours} hours ago`;
      } else if (diffDays < 7) {
        return `${diffDays} days ago`;
      } else {
        return date.toLocaleDateString('id-ID');
      }
    }

    function getConditionText(condition) {
      const conditions = {
        'baru': 'New',
        'bekas-bagus': 'Used (Good)',
        'bekas-layak': 'Used (Decent)',
        'rusak-ringan': 'Slightly Damaged'
      };
      return conditions[condition] || condition;
    }

    function getCategoryText(category) {
      const categories = {
        'buku': 'Books & Notes',
        'elektronik': 'Electronics',
        'pakaian': 'Clothing',
        'olahraga': 'Sports',
        'hobi': 'Hobbies',
        'lainnya': 'Others'
      };
      return categories[category] || category;
    }

    // Compress image before upload
    function compressImage(file, maxWidth = 800, quality = 0.7) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width, height = img.height;
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            canvas.width = width;
            canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            canvas.toBlob(blob => blob ? resolve(blob) : reject(new Error('Compression failed')), 'image/jpeg', quality);
          };
        };
      });
    }

    // Upload image to Firebase Storage
    async function uploadImageToStorage(imageBlob, productId, index) {
      const fileName = `products/${productId}/img_${index}_${Date.now()}.jpg`;
      const fileRef = storageRef(storage, fileName);
      const uploadTask = uploadBytesResumable(fileRef, imageBlob);

      return new Promise((resolve, reject) => {
        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            if (progressFill && progressText) {
              progressFill.style.width = progress + '%';
              progressText.textContent = `Uploading image ${index + 1}... ${Math.round(progress)}%`;
            }
          },
          (error) => reject(error),
          async () => {
            const url = await getDownloadURL(uploadTask.snapshot.ref);
            resolve(url);
          }
        );
      });
    }

    // Convert data URL to blob
    function dataURLtoBlob(dataURL) {
      const arr = dataURL.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }

    // ============= AUTH STATE =============
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        console.log('👤 User authenticated:', user.email);
        
        // Load user data
        await loadUserData(user.uid);
        
        // Hide login, show marketplace
        loginContainer.style.display = 'none';
        marketplaceContainer.style.display = 'block';
        document.body.style.background = 'var(--bg-color)';
        document.getElementById('background').style.display = 'none';
        
        // Load marketplace
        loadMarketplace();
        
        // Load products
        loadProducts();
        
        // Setup notifications
        setupNotificationListener(user.uid);
        
        hideLoading();
      } else {
        currentUser = null;
        currentUserData = null;
        
        // Show login, hide marketplace
        loginContainer.style.display = 'block';
        marketplaceContainer.style.display = 'none';
        document.body.style.background = 'none';
        document.getElementById('background').style.display = 'block';
        
        hideLoading();
      }
    });

    // ============= USER DATA =============
    async function loadUserData(uid) {
      try {
        const userRef = ref(database, 'users/' + uid);
        const snapshot = await get(userRef);
        
        if (snapshot.exists()) {
          currentUserData = snapshot.val();
          console.log('✅ User data loaded:', currentUserData.name);
        } else {
          // Create user data if not exists
          currentUserData = {
            uid: uid,
            email: currentUser.email,
            username: currentUser.email.split('@')[0],
            name: currentUser.displayName || 'User',
            nickname: currentUser.displayName?.split(' ')[0] || 'User',
            role: 'member',
            status: 'active',
            avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || 'User')}&background=1877f2&color=fff&size=128`,
            createdAt: new Date().toISOString(),
            lastLogin: new Date().toISOString()
          };
          
          await set(userRef, currentUserData);
          console.log('✅ User data created');
        }
        
        // Update last login
        await update(userRef, {
          lastLogin: new Date().toISOString()
        });
        
        return true;
      } catch (error) {
        console.error('Error loading user data:', error);
        return false;
      }
    }

    // ============= NOTIFICATIONS =============
    function setupNotificationListener(uid) {
      if (notificationListener) {
        notificationListener();
      }
      
      const notificationsRef = ref(database, 'notifications/' + uid);
      const notificationsQuery = query(notificationsRef, orderByChild('read'), equalTo(false));
      
      notificationListener = onValue(notificationsQuery, (snapshot) => {
        notifications = [];
        let unreadCount = 0;
        
        snapshot.forEach((childSnapshot) => {
          const notification = {
            id: childSnapshot.key,
            ...childSnapshot.val()
          };
          notifications.push(notification);
          if (!notification.read) {
            unreadCount++;
          }
        });
        
        // Update notification badge
        const badge = document.getElementById('notification-count');
        if (badge) {
          badge.textContent = unreadCount;
          badge.style.display = unreadCount > 0 ? 'flex' : 'none';
        }
        
        // Update notification dropdown if open
        updateNotificationDropdown();
      });
    }

    function updateNotificationDropdown() {
      const dropdown = document.querySelector('.notification-dropdown .notification-list');
      if (!dropdown || !dropdown.classList.contains('active')) return;
      
      dropdown.innerHTML = '';
      
      if (notifications.length === 0) {
        dropdown.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No notifications</div>';
        return;
      }
      
      notifications.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(notification => {
        const item = document.createElement('div');
        item.className = `notification-item ${notification.read ? '' : 'unread'}`;
        item.onclick = () => handleNotificationClick(notification);
        
        let iconClass = 'fas fa-bell';
        let iconBgClass = 'notification-icon';
        
        switch (notification.type) {
          case 'message':
            iconClass = 'fas fa-comment';
            iconBgClass += ' message';
            break;
          case 'like':
            iconClass = 'fas fa-heart';
            iconBgClass += ' like';
            break;
          case 'comment':
            iconClass = 'fas fa-comment-alt';
            iconBgClass += ' comment';
            break;
          case 'order':
            iconClass = 'fas fa-shopping-cart';
            iconBgClass += ' order';
            break;
          default:
            iconClass = 'fas fa-bell';
            iconBgClass += ' message';
        }
        
        item.innerHTML = `
          <div class="${iconBgClass}">
            <i class="${iconClass}"></i>
          </div>
          <div class="notification-content">
            <div class="notification-text">${notification.message}</div>
            <div class="notification-time">${formatTime(notification.createdAt)}</div>
          </div>
        `;
        
        dropdown.appendChild(item);
      });
    }

    async function handleNotificationClick(notification) {
      // Mark as read
      const notificationRef = ref(database, `notifications/${currentUser.uid}/${notification.id}`);
      await update(notificationRef, {
        read: true
      });
      
      // Handle different notification types
      switch (notification.type) {
        case 'message':
          navigateTo('messages');
          break;
        case 'like':
        case 'comment':
          if (notification.productId) {
            await viewProductDetail(notification.productId);
          }
          break;
        case 'order':
          // Navigate to orders
          break;
      }
    }

    async function markAllNotificationsAsRead() {
      showLoading();
      try {
        const updates = {};
        notifications.forEach(notification => {
          if (!notification.read) {
            updates[`notifications/${currentUser.uid}/${notification.id}/read`] = true;
          }
        });
        
        if (Object.keys(updates).length > 0) {
          await update(ref(database), updates);
          showSuccess('All notifications marked as read');
        }
      } catch (error) {
        console.error('Error marking notifications as read:', error);
        showError('Failed to mark notifications as read');
      } finally {
        hideLoading();
      }
    }

    // ============= PRODUCT FUNCTIONS =============
    async function loadProducts() {
      showLoading();
      try {
        const productsRef = ref(database, 'products');
        const snapshot = await get(productsRef);
        
        products = [];
        
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const product = {
              id: childSnapshot.key,
              ...childSnapshot.val()
            };
            if (product.status !== 'deleted') {
              products.push(product);
            }
          });
        }
        
        console.log(`✅ Loaded ${products.length} products`);
        displayProducts('all');
      } catch (error) {
        console.error('Error loading products:', error);
        showError('Failed to load products');
      } finally {
        hideLoading();
      }
    }

    function displayProducts(category = 'all') {
      const grid = document.getElementById('products-grid');
      if (!grid) return;
      
      let filteredProducts = category === 'all' 
        ? products 
        : products.filter(p => p.category === category);
      
      filteredProducts = filteredProducts.filter(p => p.status === 'active');
      
      if (filteredProducts.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-box-open"></i>
            <h3>No products yet</h3>
            <p>Marketplace is empty. Be the first to add a product!</p>
            <button class="btn btn-primary" id="empty-add-product-btn">
              <i class="fas fa-plus"></i> Add First Product
            </button>
          </div>
        `;
        
        document.getElementById('empty-add-product-btn')?.addEventListener('click', () => navigateTo('add-product'));
        return;
      }
      
      grid.innerHTML = '';
      
      filteredProducts.forEach(product => {
        const card = createProductCard(product);
        grid.appendChild(card);
      });
    }

    function createProductCard(product) {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.dataset.id = product.id;
      
      const sellerName = product.sellerName || 'Unknown';
      const sellerAvatar = product.sellerAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(sellerName)}&background=1877f2&color=fff&size=64`;
      
      const productImage = product.images?.[0] || 'https://via.placeholder.com/300x200?text=No+Image';
      
      card.innerHTML = `
        <img src="${productImage}" 
             alt="${product.name}" 
             class="product-image"
             loading="lazy"
             onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
        <div class="product-info">
          <div class="product-title">${product.name}</div>
          <div class="product-price">Rp ${product.price?.toLocaleString('id-ID') || '0'}</div>
          <div class="product-seller">
            <img src="${sellerAvatar}" 
                 alt="Seller" 
                 class="seller-avatar"
                 loading="lazy">
            <span class="seller-name">${sellerName}</span>
          </div>
          <div class="product-actions">
            <button class="btn btn-primary btn-sm" onclick="window.viewProductDetail('${product.id}')">Detail</button>
            <button class="btn btn-secondary btn-sm" onclick="window.likeProduct('${product.id}')">
              <i class="fas fa-heart"></i> ${product.likes ? Object.keys(product.likes).length : 0}
            </button>
          </div>
        </div>
      `;
      
      card.addEventListener('click', (e) => {
        if (!e.target.classList.contains('btn')) {
          window.viewProductDetail(product.id);
        }
      });
      
      return card;
    }

    async function viewProductDetail(productId) {
      showLoading();
      try {
        const productRef = ref(database, 'products/' + productId);
        const snapshot = await get(productRef);
        
        if (!snapshot.exists()) {
          showError('Product not found');
          return;
        }
        
        const product = snapshot.val();
        product.id = productId;
        
        const container = document.querySelector('.product-detail-container');
        if (!container) return;
        
        const sellerName = product.sellerName || 'Unknown';
        const sellerAvatar = product.sellerAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(sellerName)}&background=1877f2&color=fff&size=128`;
        
        container.innerHTML = `
          <div class="product-detail">
            <div class="product-images">
              <img src="${product.images?.[0] || 'https://via.placeholder.com/500x400?text=No+Image'}" 
                   alt="${product.name}" id="main-image">
              ${product.images?.length > 1 ? `
                <div class="product-thumbnails" id="thumbnails">
                  ${product.images.map((img, index) => `
                    <img src="${img}" alt="Thumbnail ${index + 1}" class="${index === 0 ? 'active' : ''}" 
                         onclick="window.changeMainImage(this)">
                  `).join('')}
                </div>
              ` : ''}
            </div>
            
            <div class="product-info-detail">
              <h1>${product.name}</h1>
              <div class="product-price-detail">Rp ${product.price?.toLocaleString('id-ID') || '0'}</div>
              
              <div class="seller-info">
                <img src="${sellerAvatar}" alt="${sellerName}" class="seller-avatar-detail">
                <div class="seller-info-detail">
                  <h3>${sellerName}</h3>
                  <p>@${product.sellerUsername || 'unknown'}</p>
                </div>
              </div>
              
              <div class="product-description">
                <h3>Description</h3>
                <p>${product.description || 'No description'}</p>
              </div>
              
              <div style="margin-bottom: 20px;">
                <h3>Seller Information</h3>
                <p><strong>Condition:</strong> ${getConditionText(product.condition)}</p>
                <p><strong>Category:</strong> ${getCategoryText(product.category)}</p>
                <p><strong>Contact:</strong> ${product.contact}</p>
                <p><strong>Location:</strong> ${product.location}</p>
                <p><strong>Posted:</strong> ${new Date(product.createdAt).toLocaleDateString('id-ID')}</p>
                <p><strong>Likes:</strong> ${product.likes ? Object.keys(product.likes).length : 0}</p>
              </div>
              
              <div class="action-buttons">
                <button class="btn back-btn" onclick="window.navigateTo('marketplace')">
                  <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-secondary" onclick="window.likeProduct('${product.id}')">
                  <i class="fas fa-heart"></i> Like (${product.likes ? Object.keys(product.likes).length : 0})
                </button>
                ${currentUserData?.role === 'admin' || currentUser?.uid === product.sellerId ? `
                  <button class="btn btn-warning" onclick="window.editProduct('${product.id}')">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="btn btn-danger" onclick="window.deleteProduct('${product.id}')">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                ` : `
                  <button class="btn btn-primary" onclick="window.buyProduct('${product.id}')">
                    <i class="fas fa-shopping-cart"></i> Buy Now
                  </button>
                  <button class="btn btn-secondary" onclick="window.messageSeller('${product.sellerId}', '${product.id}')">
                    <i class="fas fa-comment"></i> Ask Seller
                  </button>
                `}
              </div>
            </div>
          </div>
        `;
        
        navigateTo('product-detail');
      } catch (error) {
        console.error('Error loading product detail:', error);
        showError('Failed to load product details');
      } finally {
        hideLoading();
      }
    }

    function changeMainImage(imgElement) {
      const mainImage = document.getElementById('main-image');
      if (mainImage) {
        mainImage.src = imgElement.src;
        document.querySelectorAll('.product-thumbnails img').forEach(img => img.classList.remove('active'));
        imgElement.classList.add('active');
      }
    }

    async function likeProduct(productId) {
      if (!currentUser) {
        showError('Please login first');
        return;
      }
      
      showLoading();
      try {
        const productRef = ref(database, 'products/' + productId);
        const snapshot = await get(productRef);
        
        if (!snapshot.exists()) {
          showError('Product not found');
          return;
        }
        
        const product = snapshot.val();
        const likes = product.likes || {};
        const userId = currentUser.uid;
        
        if (likes[userId]) {
          // Remove like
          await update(productRef, {
            [`likes/${userId}`]: null
          });
        } else {
          // Add like
          await update(productRef, {
            [`likes/${userId}`]: {
              userId: userId,
              userName: currentUserData?.name || 'User',
              timestamp: new Date().toISOString()
            }
          });
          
          // Create notification for product owner
          if (product.sellerId !== currentUser.uid) {
            const notificationRef = ref(database, 'notifications/' + product.sellerId);
            const newNotificationRef = push(notificationRef);
            await set(newNotificationRef, {
              type: 'like',
              message: `${currentUserData?.name || 'Someone'} liked your product "${product.name}"`,
              productId: productId,
              read: false,
              createdAt: new Date().toISOString()
            });
          }
        }
        
        // Reload products
        await loadProducts();
        showSuccess(likes[userId] ? 'Product unliked!' : 'Product liked!');
      } catch (error) {
        console.error('Error liking product:', error);
        showError('Failed to like product');
      } finally {
        hideLoading();
      }
    }

    async function buyProduct(productId) {
      if (!currentUser) {
        showError('Please login first');
        return;
      }
      
      showConfirmation('Buy Product', 'Are you sure you want to buy this product?', async () => {
        showLoading();
        try {
          const productRef = ref(database, 'products/' + productId);
          const snapshot = await get(productRef);
          
          if (!snapshot.exists()) {
            showError('Product not found');
            return;
          }
          
          const product = snapshot.val();
          
          // Create order
          const orderRef = ref(database, 'orders');
          const newOrderRef = push(orderRef);
          await set(newOrderRef, {
            productId: productId,
            productName: product.name,
            buyerId: currentUser.uid,
            buyerName: currentUserData?.name || 'User',
            sellerId: product.sellerId,
            sellerName: product.sellerName,
            price: product.price,
            status: 'pending',
            createdAt: new Date().toISOString()
          });
          
          // Send notification to seller
          const notificationRef = ref(database, 'notifications/' + product.sellerId);
          const newNotificationRef = push(notificationRef);
          await set(newNotificationRef, {
            type: 'order',
            message: `${currentUserData?.name || 'Someone'} wants to buy "${product.name}"`,
            productId: productId,
            orderId: newOrderRef.key,
            read: false,
            createdAt: new Date().toISOString()
          });
          
          showSuccess('Purchase successful! Seller will contact you.');
        } catch (error) {
          console.error('Error buying product:', error);
          showError('Failed to process purchase');
        } finally {
          hideLoading();
        }
      });
    }

    async function messageSeller(sellerId, productId) {
      if (!currentUser) {
        showError('Please login first');
        return;
      }
      
      showLoading();
      try {
        const productRef = ref(database, 'products/' + productId);
        const snapshot = await get(productRef);
        const product = snapshot.val();
        
        // Create conversation
        const conversationRef = ref(database, 'conversations');
        const newConversationRef = push(conversationRef);
        const conversationId = newConversationRef.key;
        
        await set(newConversationRef, {
          participants: {
            [currentUser.uid]: true,
            [sellerId]: true
          },
          productId: productId,
          productName: product.name,
          lastMessage: `Question about: ${product.name}`,
          lastMessageTime: new Date().toISOString(),
          createdAt: new Date().toISOString()
        });
        
        // Send initial message
        const messageRef = ref(database, 'messages/' + conversationId);
        const newMessageRef = push(messageRef);
        await set(newMessageRef, {
          senderId: currentUser.uid,
          senderName: currentUserData?.name || 'User',
          text: `Hello, I'm interested in your product "${product.name}"`,
          timestamp: new Date().toISOString()
        });
        
        // Create notification for seller
        const notificationRef = ref(database, 'notifications/' + sellerId);
        const newNotificationRef = push(notificationRef);
        await set(newNotificationRef, {
          type: 'message',
          message: `${currentUserData?.name || 'Someone'} sent you a message about "${product.name}"`,
          conversationId: conversationId,
          productId: productId,
          read: false,
          createdAt: new Date().toISOString()
        });
        
        showSuccess('Message sent successfully!');
        navigateTo('messages');
      } catch (error) {
        console.error('Error messaging seller:', error);
        showError('Failed to send message');
      } finally {
        hideLoading();
      }
    }

    async function editProduct(productId) {
      showSuccess('Edit feature coming soon');
    }

    async function deleteProduct(productId) {
      if (!currentUser) {
        showError('Please login first');
        return;
      }
      
      showConfirmation('Delete Product', 'Are you sure you want to delete this product?', async () => {
        showLoading();
        try {
          const productRef = ref(database, 'products/' + productId);
          await update(productRef, {
            status: 'deleted',
            deletedAt: new Date().toISOString()
          });
          
          showSuccess('Product deleted successfully');
          await loadProducts();
          navigateTo('my-products');
          loadMyProducts();
        } catch (error) {
          console.error('Error deleting product:', error);
          showError('Failed to delete product');
        } finally {
          hideLoading();
        }
      });
    }

    // ============= ADD PRODUCT =============
    function setupImageUpload() {
      const imageUpload = document.getElementById('image-upload');
      const imageInput = document.getElementById('image-input');
      
      if (imageUpload && imageInput) {
        imageUpload.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', handleImageSelect);
      }
    }

    function handleImageSelect(e) {
      const files = Array.from(e.target.files);
      if (files.length + selectedImages.length > 5) {
        alert('Maximum 5 images!');
        return;
      }
      
      files.forEach(file => {
        if (file.size > 5 * 1024 * 1024) {
          alert('File too large! Max 5MB');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          selectedImages.push({
            file: file,
            preview: e.target.result
          });
          renderImagePreviews();
        };
        reader.readAsDataURL(file);
      });
      
      e.target.value = '';
    }

    function renderImagePreviews() {
      const container = document.getElementById('uploaded-images');
      if (!container) return;
      
      container.innerHTML = '';
      
      selectedImages.forEach((img, index) => {
        const div = document.createElement('div');
        div.style.position = 'relative';
        div.innerHTML = `
          <img src="${img.preview}" class="uploaded-image">
          <div class="remove-image" onclick="window.removeImage(${index})">×</div>
        `;
        container.appendChild(div);
      });
    }

    function removeImage(index) {
      selectedImages.splice(index, 1);
      renderImagePreviews();
    }

    async function publishProduct() {
      if (!currentUser) {
        showError('Please login first');
        return;
      }
      
      const name = document.getElementById('product-name').value;
      const price = parseInt(document.getElementById('product-price').value);
      const category = document.getElementById('product-category').value;
      const condition = document.getElementById('product-condition').value;
      const contact = document.getElementById('product-contact').value;
      const location = document.getElementById('product-location').value;
      const description = document.getElementById('product-description')?.value || '';
      
      if (!name || !price || !category || !condition || !contact || !location) {
        showError('Please fill all required fields!');
        return;
      }
      
      if (price <= 0) {
        showError('Price must be greater than 0!');
        return;
      }
      
      if (selectedImages.length === 0) {
        showError('Please upload at least one image!');
        return;
      }
      
      showLoading();
      try {
        // Create product ID
        const productsRef = ref(database, 'products');
        const newProductRef = push(productsRef);
        const productId = newProductRef.key;
        
        // Upload images to storage
        const imageUrls = [];
        document.getElementById('uploadProgress').style.display = 'block';
        
        for (let i = 0; i < selectedImages.length; i++) {
          const compressed = await compressImage(selectedImages[i].file);
          const url = await uploadImageToStorage(compressed, productId, i);
          imageUrls.push(url);
        }
        
        // Save product to database
        await set(newProductRef, {
          name: name,
          price: price,
          category: category,
          condition: condition,
          description: description,
          contact: contact,
          location: location,
          images: imageUrls,
          sellerId: currentUser.uid,
          sellerName: currentUserData?.name || 'User',
          sellerUsername: currentUserData?.username || 'user',
          sellerAvatar: currentUserData?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUserData?.name || 'User')}&background=1877f2&color=fff&size=128`,
          status: 'active',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
        
        // Reset form
        document.getElementById('product-name').value = '';
        document.getElementById('product-price').value = '';
        document.getElementById('product-contact').value = '';
        document.getElementById('product-location').value = '';
        document.getElementById('product-description').value = '';
        selectedImages = [];
        renderImagePreviews();
        document.getElementById('uploadProgress').style.display = 'none';
        
        showSuccess('✅ Product published successfully!');
        navigateTo('marketplace');
        loadProducts();
      } catch (error) {
        console.error('Error publishing product:', error);
        showError('Failed to publish product: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    // ============= MY PRODUCTS =============
    async function loadMyProducts() {
      showLoading();
      try {
        const productsRef = ref(database, 'products');
        const productsQuery = query(productsRef, orderByChild('sellerId'), equalTo(currentUser.uid));
        const snapshot = await get(productsQuery);
        
        const grid = document.getElementById('my-products-grid');
        if (!grid) return;
        
        const myProducts = [];
        
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const product = {
              id: childSnapshot.key,
              ...childSnapshot.val()
            };
            if (product.status !== 'deleted') {
              myProducts.push(product);
            }
          });
        }
        
        if (myProducts.length === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-box"></i>
              <h3>No products yet</h3>
              <p>You haven't added any products for sale.</p>
              <button class="btn btn-primary" id="empty-my-products-btn">
                <i class="fas fa-plus"></i> Sell First Item
              </button>
            </div>
          `;
          
          document.getElementById('empty-my-products-btn')?.addEventListener('click', () => navigateTo('add-product'));
          return;
        }
        
        grid.innerHTML = '';
        
        myProducts.forEach(product => {
          const card = document.createElement('div');
          card.className = 'product-card';
          card.dataset.id = product.id;
          
          card.innerHTML = `
            <img src="${product.images?.[0] || 'https://via.placeholder.com/300x200?text=No+Image'}" 
                 alt="${product.name}" class="product-image">
            <div class="product-info">
              <div class="product-title">${product.name}</div>
              <div class="product-price">Rp ${product.price?.toLocaleString('id-ID') || '0'}</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
                ${getConditionText(product.condition)} • ${getCategoryText(product.category)}
              </div>
              <div class="product-actions">
                <button class="btn btn-primary" onclick="window.viewProductDetail('${product.id}')">View</button>
                <button class="btn btn-warning" onclick="window.editProduct('${product.id}')">Edit</button>
                <button class="btn btn-danger" onclick="window.deleteProduct('${product.id}')">Delete</button>
              </div>
            </div>
          `;
          
          grid.appendChild(card);
        });
      } catch (error) {
        console.error('Error loading my products:', error);
        showError('Failed to load your products');
      } finally {
        hideLoading();
      }
    }

    // ============= ADMIN FUNCTIONS =============
    async function loadAdminData() {
      showLoading();
      try {
        // Load users
        const usersRef = ref(database, 'users');
        const usersSnapshot = await get(usersRef);
        
        users = [];
        if (usersSnapshot.exists()) {
          usersSnapshot.forEach((childSnapshot) => {
            users.push({
              id: childSnapshot.key,
              ...childSnapshot.val()
            });
          });
        }
        
        // Load products for admin
        const productsRef = ref(database, 'products');
        const productsSnapshot = await get(productsRef);
        
        const allProducts = [];
        if (productsSnapshot.exists()) {
          productsSnapshot.forEach((childSnapshot) => {
            allProducts.push({
              id: childSnapshot.key,
              ...childSnapshot.val()
            });
          });
        }
        
        // Update stats
        updateAdminStats(users, allProducts);
        
        // Update users table
        updateUsersTable(users);
        
        // Update products table
        updateProductsTable(allProducts);
      } catch (error) {
        console.error('Error loading admin data:', error);
        showError('Failed to load admin data');
      } finally {
        hideLoading();
      }
    }

    function updateAdminStats(users, products) {
      const statsContainer = document.getElementById('admin-stats');
      if (!statsContainer) return;
      
      const totalUsers = users.length;
      const activeUsers = users.filter(u => u.status === 'active').length;
      const blockedUsers = users.filter(u => u.status === 'blocked').length;
      const admins = users.filter(u => u.role === 'admin').length;
      const totalProducts = products.filter(p => p.status === 'active').length;
      
      statsContainer.innerHTML = `
        <div class="stat-card">
          <h4>Total Users</h4>
          <div class="stat-number">${totalUsers}</div>
          <div class="stat-change">${activeUsers} active</div>
        </div>
        <div class="stat-card warning">
          <h4>Blocked Users</h4>
          <div class="stat-number">${blockedUsers}</div>
          <div class="stat-change">${((blockedUsers / totalUsers) * 100 || 0).toFixed(1)}%</div>
        </div>
        <div class="stat-card admin">
          <h4>Admins</h4>
          <div class="stat-number">${admins}</div>
          <div class="stat-change">${((admins / totalUsers) * 100 || 0).toFixed(1)}%</div>
        </div>
        <div class="stat-card success">
          <h4>Total Products</h4>
          <div class="stat-number">${totalProducts}</div>
          <div class="stat-change">Active</div>
        </div>
      `;
    }

    function updateUsersTable(users) {
      const tableBody = document.getElementById('users-table-body');
      if (!tableBody) return;
      
      tableBody.innerHTML = '';
      
      users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <strong>@${user.username || 'unknown'}</strong><br>
            <small>${user.email || ''}</small>
          </td>
          <td>${user.name || ''}<br><small>${user.nickname || ''}</small></td>
          <td><span class="status-badge ${user.role === 'admin' ? 'admin' : ''}">${user.role === 'admin' ? 'Admin' : 'Member'}</span></td>
          <td><span class="status-badge ${user.status === 'active' ? 'active' : 'blocked'}">${user.status === 'active' ? 'Active' : 'Blocked'}</span></td>
          <td>
            <div class="actions">
              ${user.status === 'active' ? `
                <button class="action-btn block" onclick="window.blockUser('${user.id}')">Block</button>
              ` : `
                <button class="action-btn unblock" onclick="window.unblockUser('${user.id}')">Activate</button>
              `}
              ${user.role !== 'admin' ? `
                <button class="action-btn promote" onclick="window.promoteToAdmin('${user.id}')">Make Admin</button>
              ` : ''}
              <button class="action-btn delete" onclick="window.deleteUserAdmin('${user.id}')">Delete</button>
            </div>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function updateProductsTable(products) {
      const tableBody = document.getElementById('products-admin-table-body');
      if (!tableBody) return;
      
      tableBody.innerHTML = '';
      
      products.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <strong>${product.name || ''}</strong><br>
            <small>${getCategoryText(product.category)} • ${getConditionText(product.condition)}</small>
          </td>
          <td>
            <strong>${product.sellerName || 'Unknown'}</strong><br>
            <small>@${product.sellerUsername || 'unknown'}</small>
          </td>
          <td>Rp ${product.price?.toLocaleString('id-ID') || '0'}</td>
          <td><span class="status-badge ${product.status === 'active' ? 'active' : 'blocked'}">${product.status === 'active' ? 'Active' : 'Inactive'}</span></td>
          <td>
            <div class="actions">
              ${product.status === 'active' ? `
                <button class="action-btn block" onclick="window.blockProduct('${product.id}')">Deactivate</button>
              ` : `
                <button class="action-btn unblock" onclick="window.unblockProduct('${product.id}')">Activate</button>
              `}
              <button class="action-btn delete" onclick="window.deleteProductAdmin('${product.id}')">Delete</button>
            </div>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    async function blockUser(userId) {
      showConfirmation('Block User', 'Are you sure you want to block this user?', async () => {
        showLoading();
        try {
          await update(ref(database, 'users/' + userId), {
            status: 'blocked',
            updatedAt: new Date().toISOString()
          });
          showSuccess('User blocked successfully');
          loadAdminData();
        } catch (error) {
          console.error('Error blocking user:', error);
          showError('Failed to block user');
        } finally {
          hideLoading();
        }
      });
    }

    async function unblockUser(userId) {
      showConfirmation('Activate User', 'Are you sure you want to activate this user?', async () => {
        showLoading();
        try {
          await update(ref(database, 'users/' + userId), {
            status: 'active',
            updatedAt: new Date().toISOString()
          });
          showSuccess('User activated successfully');
          loadAdminData();
        } catch (error) {
          console.error('Error unblocking user:', error);
          showError('Failed to activate user');
        } finally {
          hideLoading();
        }
      });
    }

    async function promoteToAdmin(userId) {
      showConfirmation('Make Admin', 'Are you sure you want to make this user an admin?', async () => {
        showLoading();
        try {
          await update(ref(database, 'users/' + userId), {
            role: 'admin',
            updatedAt: new Date().toISOString()
          });
          showSuccess('User promoted to admin successfully');
          loadAdminData();
        } catch (error) {
          console.error('Error promoting user:', error);
          showError('Failed to promote user');
        } finally {
          hideLoading();
        }
      });
    }

    async function deleteUserAdmin(userId) {
      showConfirmation('Delete User', 'Are you sure you want to permanently delete this user?', async () => {
        showLoading();
        try {
          await remove(ref(database, 'users/' + userId));
          showSuccess('User deleted successfully');
          loadAdminData();
        } catch (error) {
          console.error('Error deleting user:', error);
          showError('Failed to delete user');
        } finally {
          hideLoading();
        }
      });
    }

    async function blockProduct(productId) {
      showConfirmation('Deactivate Product', 'Are you sure you want to deactivate this product?', async () => {
        showLoading();
        try {
          await update(ref(database, 'products/' + productId), {
            status: 'blocked',
            updatedAt: new Date().toISOString()
          });
          showSuccess('Product deactivated successfully');
          loadAdminData();
        } catch (error) {
          console.error('Error blocking product:', error);
          showError('Failed to deactivate product');
        } finally {
          hideLoading();
        }
      });
    }

    async function unblockProduct(productId) {
      showConfirmation('Activate Product', 'Are you sure you want to activate this product?', async () => {
        showLoading();
        try {
          await update(ref(database, 'products/' + productId), {
            status: 'active',
            updatedAt: new Date().toISOString()
          });
          showSuccess('Product activated successfully');
          loadAdminData();
        } catch (error) {
          console.error('Error unblocking product:', error);
          showError('Failed to activate product');
        } finally {
          hideLoading();
        }
      });
    }

    async function deleteProductAdmin(productId) {
      showConfirmation('Delete Product', 'Are you sure you want to permanently delete this product?', async () => {
        showLoading();
        try {
          await remove(ref(database, 'products/' + productId));
          showSuccess('Product deleted successfully');
          loadAdminData();
        } catch (error) {
          console.error('Error deleting product:', error);
          showError('Failed to delete product');
        } finally {
          hideLoading();
        }
      });
    }

    // ============= MARKETPLACE UI =============
    function loadMarketplace() {
      const isAdmin = currentUserData?.role === 'admin';
      const avatarUrl = currentUserData?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUserData?.name || 'User')}&background=${isAdmin ? '8a2be2' : '1877f2'}&color=fff&size=128`;
      
      marketplaceContainer.innerHTML = `
        <header>
          <nav class="navbar">
            <a href="#" class="logo" onclick="location.reload()">
              <img src="https://files.catbox.moe/ll5y61.png" alt="Diponegoro Market Logo" class="logo-img">
              <span class="logo-text">DIPONEGORO MARKET</span>
            </a>
            
            <div class="nav-links">
              <a href="#" class="nav-item active" data-target="marketplace">
                <i class="fas fa-store-alt"></i>
                <span>Marketplace</span>
              </a>
              <a href="#" class="nav-item" data-target="messages">
                <i class="fas fa-comments"></i>
                <span>Messages</span>
              </a>
              ${isAdmin ? `
                <a href="#" class="nav-item admin-badge" data-target="admin">
                  <i class="fas fa-shield-alt"></i>
                  <span>Admin</span>
                </a>
              ` : ''}
            </div>
            
            <div class="user-actions">
              <div class="notification" id="notification-icon">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notification-count" style="display: none;">0</span>
                <div class="notification-dropdown" id="notification-dropdown">
                  <div class="notification-header">
                    <h3>Notifications</h3>
                    <button class="mark-all-read" id="mark-all-read">Mark all as read</button>
                  </div>
                  <div class="notification-list">
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">No notifications</div>
                  </div>
                </div>
              </div>
              <div class="user-profile">
                <img src="${avatarUrl}" alt="User Avatar" class="user-avatar ${isAdmin ? 'admin' : ''}" id="user-avatar">
                <div class="profile-dropdown" id="profile-dropdown">
                  <div class="dropdown-header">
                    <img src="${avatarUrl}" alt="User Avatar" class="dropdown-avatar">
                    <div class="dropdown-user-info">
                      <h4>${currentUserData?.nickname || 'User'}</h4>
                      <p>@${currentUserData?.username || 'user'}</p>
                      ${isAdmin ? '<small style="color: var(--admin-color); font-weight: bold;">ADMIN</small>' : ''}
                    </div>
                  </div>
                  <ul class="dropdown-menu">
                    <li><a href="#" class="dropdown-item" id="add-product-menu"><i class="fas fa-plus-circle"></i> Sell Item</a></li>
                    <li><a href="#" class="dropdown-item" id="my-products-menu"><i class="fas fa-box"></i> My Items</a></li>
                    <li><a href="#" class="dropdown-item" id="profile-settings-menu"><i class="fas fa-user-cog"></i> Profile Settings</a></li>
                    ${isAdmin ? '<li><a href="#" class="dropdown-item" id="admin-menu"><i class="fas fa-shield-alt"></i> Admin Panel</a></li>' : ''}
                    <li><a href="#" class="dropdown-item logout" id="logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                  </ul>
                </div>
              </div>
            </div>
          </nav>
        </header>

        <div class="container-marketplace">
          <main class="main-content">
            <!-- Marketplace Section -->
            <section id="marketplace" class="content-section active">
              <div class="marketplace-header">
                <h1 class="section-title">Diponegoro Marketplace</h1>
                <div class="search-bar">
                  <i class="fas fa-search"></i>
                  <input type="text" id="search-input" placeholder="Search products, username, or seller...">
                </div>
                <button class="add-product-btn" id="add-product-btn">
                  <i class="fas fa-plus"></i>
                  <span>Sell Item</span>
                </button>
              </div>
              
              <div class="categories">
                <div class="category active" data-category="all">All</div>
                <div class="category" data-category="buku">Books & Notes</div>
                <div class="category" data-category="elektronik">Electronics</div>
                <div class="category" data-category="pakaian">Clothing</div>
                <div class="category" data-category="olahraga">Sports</div>
                <div class="category" data-category="hobi">Hobbies</div>
                <div class="category" data-category="lainnya">Others</div>
              </div>
              
              <div class="products-grid" id="products-grid">
                <div class="empty-state">
                  <i class="fas fa-box-open"></i>
                  <h3>No products yet</h3>
                  <p>Marketplace is empty. Be the first to add a product!</p>
                  <button class="btn btn-primary" id="empty-add-product-btn">
                    <i class="fas fa-plus"></i> Add First Product
                  </button>
                </div>
              </div>
            </section>
            
            <!-- Messages Section -->
            <section id="messages" class="content-section">
              <h1 class="section-title">Direct Messages</h1>
              <div class="messages-container">
                <div class="empty-state">
                  <i class="fas fa-comments"></i>
                  <h3>No messages yet</h3>
                  <p>Start a conversation with a seller or buyer</p>
                </div>
              </div>
            </section>
            
            <!-- Admin Panel Section -->
            <section id="admin" class="content-section">
              <h1 class="section-title">Admin Panel</h1>
              <div class="admin-panel">
                <div class="stats-grid" id="admin-stats">
                  <!-- Stats will be loaded here -->
                </div>
                
                <div class="admin-section">
                  <h3>Users</h3>
                  <div class="admin-table-container">
                    <table class="admin-table" id="users-table">
                      <thead>
                        <tr>
                          <th>Username</th>
                          <th>Name</th>
                          <th>Role</th>
                          <th>Status</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="users-table-body">
                        <!-- Users will be loaded here -->
                      </tbody>
                    </table>
                  </div>
                </div>
                
                <div class="admin-section">
                  <h3>Products</h3>
                  <div class="admin-table-container">
                    <table class="admin-table" id="products-admin-table">
                      <thead>
                        <tr>
                          <th>Product Name</th>
                          <th>Seller</th>
                          <th>Price</th>
                          <th>Status</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="products-admin-table-body">
                        <!-- Products will be loaded here -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </section>
            
            <!-- Settings Section -->
            <section id="settings" class="content-section">
              <h1 class="section-title">Profile Settings</h1>
              <div class="settings-container">
                <div class="settings-tabs">
                  <div class="settings-tab active" data-tab="profile">Profile</div>
                  <div class="settings-tab" data-tab="security">Security</div>
                  <div class="settings-tab" data-tab="notifications">Notifications</div>
                </div>
                
                <!-- Profile Settings -->
                <div class="settings-content active" id="profile-settings">
                  <div class="settings-section">
                    <h3>Profile Picture</h3>
                    <div class="profile-picture-section">
                      <img src="${avatarUrl}" alt="Profile Picture" class="profile-preview" id="profile-preview">
                      <div class="profile-upload-options">
                        <button type="button" class="upload-option-btn camera" id="camera-upload">
                          <i class="fas fa-camera"></i> Camera
                        </button>
                        <button type="button" class="upload-option-btn album" id="album-upload">
                          <i class="fas fa-images"></i> Album
                        </button>
                        <input type="file" id="profile-image-input" accept="image/*" style="display: none;">
                      </div>
                    </div>
                  </div>
                  
                  <form class="settings-form" id="profile-form">
                    <div class="form-group">
                      <label for="settings-name">Full Name</label>
                      <input type="text" id="settings-name" value="${currentUserData?.name || ''}" required>
                    </div>
                    
                    <div class="form-group">
                      <label for="settings-nickname">Nickname</label>
                      <input type="text" id="settings-nickname" value="${currentUserData?.nickname || ''}">
                    </div>
                    
                    <div class="form-group">
                      <label for="settings-username">Username</label>
                      <input type="text" id="settings-username" value="${currentUserData?.username || ''}" required>
                      <span class="form-info">Unique username for profile</span>
                    </div>
                    
                    <div class="form-group">
                      <label for="settings-phone">Phone Number</label>
                      <input type="tel" id="settings-phone" value="${currentUserData?.phone || ''}">
                    </div>
                    
                    <div class="form-group">
                      <label for="settings-bio">Bio</label>
                      <textarea id="settings-bio" placeholder="Write something about yourself...">${currentUserData?.bio || ''}</textarea>
                    </div>
                    
                    <div class="action-buttons">
                      <button type="button" class="btn back-btn" onclick="window.navigateTo('marketplace')">
                        <i class="fas fa-arrow-left"></i> Back
                      </button>
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                      </button>
                    </div>
                  </form>
                </div>
                
                <!-- Security Settings -->
                <div class="settings-content" id="security-settings">
                  <form class="settings-form" id="security-form">
                    <div class="settings-section">
                      <h3>Change Email</h3>
                      <div class="form-group">
                        <label for="current-email">Current Email</label>
                        <input type="email" id="current-email" value="${currentUserData?.email || ''}" disabled>
                      </div>
                      
                      <div class="form-group">
                        <label for="new-email">New Email</label>
                        <input type="email" id="new-email" placeholder="email@example.com">
                      </div>
                      
                      <div class="form-group">
                        <label for="confirm-email">Confirm New Email</label>
                        <input type="email" id="confirm-email" placeholder="email@example.com">
                      </div>
                      
                      <button type="button" class="btn btn-secondary" id="update-email-btn">
                        <i class="fas fa-envelope"></i> Update Email
                      </button>
                    </div>
                    
                    <div class="settings-section">
                      <h3>Change Password</h3>
                      <div class="form-group">
                        <label for="current-password">Current Password</label>
                        <input type="password" id="current-password" placeholder="Current password">
                      </div>
                      
                      <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" placeholder="New password">
                        <div class="password-strength" id="new-password-strength">
                          <div class="password-strength-bar"></div>
                        </div>
                      </div>
                      
                      <div class="form-group">
                        <label for="confirm-password">Confirm New Password</label>
                        <input type="password" id="confirm-password" placeholder="Confirm new password">
                      </div>
                      
                      <button type="button" class="btn btn-primary" id="update-password-btn">
                        <i class="fas fa-key"></i> Update Password
                      </button>
                    </div>
                    
                    <div class="action-buttons">
                      <button type="button" class="btn back-btn" onclick="window.navigateTo('marketplace')">
                        <i class="fas fa-arrow-left"></i> Back
                      </button>
                    </div>
                  </form>
                </div>
                
                <!-- Notification Settings -->
                <div class="settings-content" id="notification-settings">
                  <form class="settings-form" id="notification-form">
                    <div class="settings-section">
                      <h3>Notification Settings</h3>
                      
                      <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                          <input type="checkbox" id="notify-messages" checked>
                          <span>Message Notifications</span>
                        </label>
                        <span class="form-info">Get notified when you receive a new message</span>
                      </div>
                      
                      <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                          <input type="checkbox" id="notify-likes" checked>
                          <span>Like Notifications</span>
                        </label>
                        <span class="form-info">Get notified when someone likes your product</span>
                      </div>
                      
                      <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                          <input type="checkbox" id="notify-orders" checked>
                          <span>Order Notifications</span>
                        </label>
                        <span class="form-info">Get notified when someone orders your product</span>
                      </div>
                      
                      <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                          <input type="checkbox" id="email-notifications" checked>
                          <span>Email Notifications</span>
                        </label>
                        <span class="form-info">Receive notifications via email</span>
                      </div>
                    </div>
                    
                    <div class="action-buttons">
                      <button type="button" class="btn back-btn" onclick="window.navigateTo('marketplace')">
                        <i class="fas fa-arrow-left"></i> Back
                      </button>
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Settings
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </section>
            
            <!-- Product Detail Section -->
            <section id="product-detail" class="content-section">
              <div class="product-detail-container">
                <div class="empty-state">
                  <i class="fas fa-box"></i>
                  <h3>Product not found</h3>
                  <button class="btn back-btn" onclick="window.navigateTo('marketplace')">
                    <i class="fas fa-arrow-left"></i> Back to Marketplace
                  </button>
                </div>
              </div>
            </section>
            
            <!-- Add Product Section -->
            <section id="add-product" class="content-section">
              <h1 class="section-title">Sell New Item</h1>
              <div class="add-product-form">
                <div class="form-group">
                  <label for="product-name">Product Name</label>
                  <input type="text" id="product-name" placeholder="e.g., Mathematics Textbook" required>
                </div>
                
                <div class="form-group">
                  <label for="product-price">Price (Rp)</label>
                  <input type="number" id="product-price" placeholder="e.g., 50000" min="0" required>
                </div>
                
                <div class="form-row" style="display: flex; gap: 15px;">
                  <div class="form-group" style="flex: 1;">
                    <label for="product-category">Category</label>
                    <select id="product-category" required>
                      <option value="buku">Books & Notes</option>
                      <option value="elektronik">Electronics</option>
                      <option value="pakaian">Clothing</option>
                      <option value="olahraga">Sports</option>
                      <option value="hobi">Hobbies</option>
                      <option value="lainnya">Others</option>
                    </select>
                  </div>
                  <div class="form-group" style="flex: 1;">
                    <label for="product-condition">Condition</label>
                    <select id="product-condition" required>
                      <option value="baru">New</option>
                      <option value="bekas-bagus">Used (Good)</option>
                      <option value="bekas-layak">Used (Decent)</option>
                      <option value="rusak-ringan">Slightly Damaged</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Product Photos (Max 5)</label>
                  <div class="image-upload" id="image-upload">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Click to upload images</p>
                    <p style="font-size: 14px; color: var(--text-secondary);">Format: JPG, PNG, Max 5MB</p>
                  </div>
                  <input type="file" id="image-input" accept="image/*" multiple style="display: none;">
                  <div class="uploaded-images" id="uploaded-images"></div>
                  <div class="upload-progress" id="uploadProgress" style="display: none; margin-top: 15px;">
                    <div class="progress-bar" style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                      <div class="progress-fill" id="progressFill" style="height: 100%; background: linear-gradient(135deg, #667eea, #764ba2); width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div class="progress-text" id="progressText" style="text-align: center; margin-top: 8px; font-size: 13px; color: #666;">Uploading... 0%</div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="product-contact">Contact Information</label>
                  <input type="text" id="product-contact" placeholder="WhatsApp/Line/Instagram" required>
                </div>
                
                <div class="form-group">
                  <label for="product-location">Pickup Location</label>
                  <input type="text" id="product-location" placeholder="e.g., FISIP Building Undip" required>
                </div>
                
                <div class="form-group">
                  <label for="product-description">Description</label>
                  <textarea id="product-description" placeholder="Describe your product..."></textarea>
                </div>
                
                <div class="action-buttons">
                  <button class="btn back-btn" id="cancel-add-product">
                    <i class="fas fa-arrow-left"></i> Back
                  </button>
                  <button class="btn btn-primary" id="publish-product">
                    <i class="fas fa-paper-plane"></i> Publish Product
                  </button>
                </div>
              </div>
            </section>
            
            <!-- My Products Section -->
            <section id="my-products" class="content-section">
              <h1 class="section-title">My Products</h1>
              <div class="products-grid" id="my-products-grid">
                <div class="empty-state">
                  <i class="fas fa-box"></i>
                  <h3>No products yet</h3>
                  <p>You haven't added any products for sale.</p>
                  <button class="btn btn-primary" id="empty-my-products-btn">
                    <i class="fas fa-plus"></i> Sell First Item
                  </button>
                </div>
              </div>
            </section>
          </main>
        </div>

        <footer>
          <p>&copy; 2026 Diponegoro Marketplace. Buy and sell platform for SMK Diponegoro Majenang students.</p>
        </footer>
      `;
      
      initializeMarketplace();
    }

    function initializeMarketplace() {
      setupEventListeners();
      setupImageUpload();
      
      if (currentUserData?.role === 'admin') {
        loadAdminData();
      }
    }

    function setupEventListeners() {
      // Profile dropdown
      document.getElementById('user-avatar')?.addEventListener('click', toggleProfileDropdown);
      document.addEventListener('click', closeProfileDropdown);
      
      // Notification dropdown
      document.getElementById('notification-icon')?.addEventListener('click', toggleNotificationDropdown);
      document.addEventListener('click', closeNotificationDropdown);
      
      // Mark all as read
      document.getElementById('mark-all-read')?.addEventListener('click', markAllNotificationsAsRead);
      
      // Navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const target = e.currentTarget.getAttribute('data-target');
          navigateTo(target);
        });
      });
      
      // Dropdown menu actions
      document.getElementById('add-product-menu')?.addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo('add-product');
        closeProfileDropdown();
      });
      
      document.getElementById('my-products-menu')?.addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo('my-products');
        loadMyProducts();
        closeProfileDropdown();
      });
      
      document.getElementById('profile-settings-menu')?.addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo('settings');
        closeProfileDropdown();
      });
      
      document.getElementById('admin-menu')?.addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo('admin');
        loadAdminData();
        closeProfileDropdown();
      });
      
      // Logout
      document.getElementById('logout')?.addEventListener('click', (e) => {
        e.preventDefault();
        showConfirmation('Logout', 'Are you sure you want to logout?', () => {
          signOut(auth);
        });
        closeProfileDropdown();
      });
      
      // Settings tabs
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.getAttribute('data-tab');
          switchSettingsTab(tabId);
        });
      });
      
      // Profile form
      document.getElementById('profile-form')?.addEventListener('submit', updateProfile);
      
      // Update email
      document.getElementById('update-email-btn')?.addEventListener('click', updateEmail);
      
      // Update password
      document.getElementById('update-password-btn')?.addEventListener('click', updatePassword);
      
      // Password strength indicator
      const newPasswordInput = document.getElementById('new-password');
      if (newPasswordInput) {
        newPasswordInput.addEventListener('input', updatePasswordStrength);
      }
      
      // Profile picture upload
      document.getElementById('camera-upload')?.addEventListener('click', openCamera);
      document.getElementById('album-upload')?.addEventListener('click', () => {
        document.getElementById('profile-image-input').click();
      });
      document.getElementById('profile-image-input')?.addEventListener('change', handleProfileImageUpload);
      
      // Camera modal
      document.getElementById('close-camera-modal')?.addEventListener('click', closeCamera);
      document.getElementById('cancel-camera')?.addEventListener('click', closeCamera);
      document.getElementById('switch-camera')?.addEventListener('click', switchCamera);
      document.getElementById('capture-photo')?.addEventListener('click', capturePhoto);
      
      // Add product button
      document.getElementById('add-product-btn')?.addEventListener('click', () => navigateTo('add-product'));
      document.getElementById('empty-add-product-btn')?.addEventListener('click', () => navigateTo('add-product'));
      document.getElementById('empty-my-products-btn')?.addEventListener('click', () => navigateTo('add-product'));
      
      // Publish product
      document.getElementById('publish-product')?.addEventListener('click', publishProduct);
      
      // Cancel add product
      document.getElementById('cancel-add-product')?.addEventListener('click', () => navigateTo('marketplace'));
      
      // Categories
      document.querySelectorAll('.category').forEach(cat => {
        cat.addEventListener('click', function() {
          document.querySelectorAll('.category').forEach(c => c.classList.remove('active'));
          this.classList.add('active');
          filterProducts(this.getAttribute('data-category'));
        });
      });
      
      // Search
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => searchProducts(e.target.value));
      }
      
      // Modal
      setupModal();
    }

    // ============= NAVIGATION =============
    function navigateTo(section) {
      document.querySelectorAll('.nav-item').forEach(nav => {
        nav.classList.remove('active');
        if (nav.getAttribute('data-target') === section) {
          nav.classList.add('active');
        }
      });
      
      document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
      });
      
      const targetSection = document.getElementById(section);
      if (targetSection) {
        targetSection.classList.add('active');
      }
    }

    // ============= PROFILE DROPDOWN =============
    function toggleProfileDropdown(e) {
      e.stopPropagation();
      const dropdown = document.getElementById('profile-dropdown');
      dropdown.classList.toggle('active');
    }

    function closeProfileDropdown(e) {
      const dropdown = document.getElementById('profile-dropdown');
      if (!e?.target.closest('.user-profile')) {
        dropdown.classList.remove('active');
      }
    }

    // ============= NOTIFICATION DROPDOWN =============
    function toggleNotificationDropdown(e) {
      e.stopPropagation();
      const dropdown = document.getElementById('notification-dropdown');
      dropdown.classList.toggle('active');
      updateNotificationDropdown();
    }

    function closeNotificationDropdown(e) {
      const dropdown = document.getElementById('notification-dropdown');
      if (!e?.target.closest('.notification')) {
        dropdown.classList.remove('active');
      }
    }

    // ============= SETTINGS =============
    function switchSettingsTab(tabId) {
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-tab') === tabId) {
          tab.classList.add('active');
        }
      });
      
      document.querySelectorAll('.settings-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabId + '-settings').classList.add('active');
    }

    async function updateProfile(e) {
      e.preventDefault();
      
      showLoading();
      try {
        const updates = {
          name: document.getElementById('settings-name').value,
          nickname: document.getElementById('settings-nickname').value,
          username: document.getElementById('settings-username').value,
          phone: document.getElementById('settings-phone').value,
          bio: document.getElementById('settings-bio').value,
          updatedAt: new Date().toISOString()
        };
        
        await update(ref(database, 'users/' + currentUser.uid), updates);
        
        currentUserData = { ...currentUserData, ...updates };
        
        showSuccess('Profile updated successfully!');
      } catch (error) {
        console.error('Error updating profile:', error);
        showError('Failed to update profile');
      } finally {
        hideLoading();
      }
    }

    async function updateEmail() {
      const newEmail = document.getElementById('new-email').value;
      const confirmEmail = document.getElementById('confirm-email').value;
      
      if (!newEmail || !confirmEmail) {
        showError('Please fill all email fields');
        return;
      }
      
      if (newEmail !== confirmEmail) {
        showError('Emails do not match');
        return;
      }
      
      if (newEmail === currentUserData?.email) {
        showError('New email must be different from current email');
        return;
      }
      
      showConfirmation('Update Email', 'Are you sure you want to update your email?', async () => {
        showLoading();
        try {
          await currentUser.updateEmail(newEmail);
          
          await update(ref(database, 'users/' + currentUser.uid), {
            email: newEmail,
            updatedAt: new Date().toISOString()
          });
          
          currentUserData.email = newEmail;
          document.getElementById('current-email').value = newEmail;
          document.getElementById('new-email').value = '';
          document.getElementById('confirm-email').value = '';
          
          showSuccess('Email updated successfully!');
        } catch (error) {
          console.error('Error updating email:', error);
          
          if (error.code === 'auth/requires-recent-login') {
            showError('Session expired. Please login again.');
            setTimeout(() => signOut(auth), 3000);
          } else {
            showError('Failed to update email: ' + error.message);
          }
        } finally {
          hideLoading();
        }
      });
    }

    function updatePasswordStrength() {
      const password = document.getElementById('new-password').value;
      const strengthBar = document.getElementById('new-password-strength');
      const bar = strengthBar.querySelector('.password-strength-bar');
      
      let strength = 0;
      
      if (password.length >= 8) strength += 1;
      if (/[a-z]/.test(password)) strength += 1;
      if (/[A-Z]/.test(password)) strength += 1;
      if (/[0-9]/.test(password)) strength += 1;
      if (/[^A-Za-z0-9]/.test(password)) strength += 1;
      
      strengthBar.className = 'password-strength';
      if (password.length === 0) {
        return;
      } else if (strength <= 2) {
        strengthBar.classList.add('weak');
      } else if (strength <= 4) {
        strengthBar.classList.add('medium');
      } else {
        strengthBar.classList.add('strong');
      }
    }

    async function updatePassword() {
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      if (!currentPassword || !newPassword || !confirmPassword) {
        showError('Please fill all password fields');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showError('New passwords do not match');
        return;
      }
      
      if (newPassword.length < 6) {
        showError('Password must be at least 6 characters');
        return;
      }
      
      showConfirmation('Update Password', 'Are you sure you want to update your password?', async () => {
        showLoading();
        try {
          // Re-authenticate user
          const credential = await import('firebase/auth').then(
            (module) => module.EmailAuthProvider.credential(currentUser.email, currentPassword)
          );
          
          await currentUser.reauthenticateWithCredential(credential);
          
          // Update password
          await currentUser.updatePassword(newPassword);
          
          document.getElementById('current-password').value = '';
          document.getElementById('new-password').value = '';
          document.getElementById('confirm-password').value = '';
          
          showSuccess('Password updated successfully!');
        } catch (error) {
          console.error('Error updating password:', error);
          
          if (error.code === 'auth/wrong-password') {
            showError('Current password is incorrect');
          } else if (error.code === 'auth/requires-recent-login') {
            showError('Session expired. Please login again.');
            setTimeout(() => signOut(auth), 3000);
          } else {
            showError('Failed to update password: ' + error.message);
          }
        } finally {
          hideLoading();
        }
      });
    }

    // ============= PROFILE PICTURE =============
    async function openCamera() {
      try {
        const modal = document.getElementById('camera-modal');
        modal.classList.add('active');
        
        const video = document.getElementById('camera-preview');
        
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentFacingMode },
          audio: false
        });
        
        video.srcObject = cameraStream;
        video.play();
      } catch (error) {
        console.error('Error opening camera:', error);
        showError('Cannot access camera');
        closeCamera();
      }
    }

    function closeCamera() {
      const modal = document.getElementById('camera-modal');
      modal.classList.remove('active');
      
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
    }

    async function switchCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      
      currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
      
      const video = document.getElementById('camera-preview');
      cameraStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: currentFacingMode },
        audio: false
      });
      
      video.srcObject = cameraStream;
      video.play();
    }

    function capturePhoto() {
      const video = document.getElementById('camera-preview');
      const canvas = document.getElementById('camera-canvas');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      const photoData = canvas.toDataURL('image/jpeg');
      
      updateProfilePicture(photoData);
      
      closeCamera();
    }

    function handleProfileImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.type.match('image.*')) {
        showError('File must be an image');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        updateProfilePicture(e.target.result);
      };
      reader.readAsDataURL(file);
      
      e.target.value = '';
    }

    async function updateProfilePicture(imageData) {
      showLoading();
      try {
        // Upload to Firebase Storage
        const fileName = `profile-pictures/${currentUser.uid}_${Date.now()}.jpg`;
        const fileRef = storageRef(storage, fileName);
        const blob = dataURLtoBlob(imageData);
        await uploadBytesResumable(fileRef, blob);
        const imageUrl = await getDownloadURL(fileRef);
        
        // Update user data
        await update(ref(database, 'users/' + currentUser.uid), {
          avatar: imageUrl,
          updatedAt: new Date().toISOString()
        });
        
        // Update current user data
        currentUserData.avatar = imageUrl;
        
        // Update UI
        document.getElementById('profile-preview').src = imageUrl;
        document.getElementById('user-avatar').src = imageUrl;
        const dropdownAvatar = document.querySelector('.dropdown-avatar');
        if (dropdownAvatar) dropdownAvatar.src = imageUrl;
        
        showSuccess('Profile picture updated successfully!');
      } catch (error) {
        console.error('Error updating profile picture:', error);
        showError('Failed to update profile picture');
      } finally {
        hideLoading();
      }
    }

    // ============= FILTER & SEARCH =============
    function filterProducts(category) {
      displayProducts(category);
    }

    function searchProducts(query) {
      const grid = document.getElementById('products-grid');
      if (!grid) return;
      
      if (!query.trim()) {
        displayProducts();
        return;
      }
      
      const filtered = products.filter(product => {
        const searchLower = query.toLowerCase();
        return product.name?.toLowerCase().includes(searchLower) ||
               product.sellerName?.toLowerCase().includes(searchLower) ||
               product.sellerUsername?.toLowerCase().includes(searchLower);
      });
      
      if (filtered.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-search"></i>
            <h3>No products found</h3>
            <p>No products match your search "${query}"</p>
            <button class="btn btn-primary" onclick="document.getElementById('search-input').value=''; window.filterProducts('all')">
              <i class="fas fa-redo"></i> Show All Products
            </button>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = '';
      filtered.forEach(product => {
        const card = createProductCard(product);
        grid.appendChild(card);
      });
    }

    // ============= MODAL =============
    function setupModal() {
      const modal = document.getElementById('confirmation-modal');
      const closeBtn = document.getElementById('close-modal');
      const cancelBtn = document.getElementById('modal-cancel');
      
      if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.remove('active'));
      if (cancelBtn) cancelBtn.addEventListener('click', () => modal.classList.remove('active'));
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.remove('active');
      });
    }

    function showConfirmation(title, message, confirmCallback) {
      const modal = document.getElementById('confirmation-modal');
      const modalTitle = document.getElementById('modal-title');
      const modalMessage = document.getElementById('modal-message');
      const confirmBtn = document.getElementById('modal-confirm');
      
      if (!modal || !modalTitle || !modalMessage || !confirmBtn) return;
      
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modal.classList.add('active');
      
      confirmBtn.onclick = () => {
        confirmCallback();
        modal.classList.remove('active');
      };
    }

    // ============= LOGIN/REGISTER UI =============
    function showLoginForm() {
      document.querySelector('.login-card').style.display = 'block';
      document.querySelector('.register-card').style.display = 'none';
      
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById('loginTab').classList.add('active');
      document.getElementById('loginTab2').classList.add('active');
      
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';
    }

    function showRegisterForm() {
      document.querySelector('.login-card').style.display = 'none';
      document.querySelector('.register-card').style.display = 'block';
      
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById('registerTab').classList.add('active');
      document.getElementById('registerTab2').classList.add('active');
      
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';
      document.getElementById('registerErrorMessage').style.display = 'none';
      document.getElementById('registerSuccessMessage').style.display = 'none';
    }

    // ============= INITIALIZATION =============
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Document ready');
      
      // Set up tab switching
      document.getElementById('loginTab')?.addEventListener('click', showLoginForm);
      document.getElementById('registerTab')?.addEventListener('click', showRegisterForm);
      document.getElementById('loginTab2')?.addEventListener('click', showLoginForm);
      document.getElementById('registerTab2')?.addEventListener('click', showRegisterForm);
      document.getElementById('backToLogin')?.addEventListener('click', (e) => {
        e.preventDefault();
        showLoginForm();
      });
      
      // Password strength indicator for registration
      const regPasswordInput = document.getElementById('regPassword');
      const passwordStrengthBar = document.getElementById('passwordStrength');
      
      if (regPasswordInput && passwordStrengthBar) {
        regPasswordInput.addEventListener('input', function() {
          const password = this.value;
          const bar = passwordStrengthBar.querySelector('.password-strength-bar');
          
          let strength = 0;
          
          if (password.length >= 8) strength += 1;
          if (/[a-z]/.test(password)) strength += 1;
          if (/[A-Z]/.test(password)) strength += 1;
          if (/[0-9]/.test(password)) strength += 1;
          if (/[^A-Za-z0-9]/.test(password)) strength += 1;
          
          passwordStrengthBar.className = 'password-strength';
          if (password.length === 0) {
            return;
          } else if (strength <= 2) {
            passwordStrengthBar.classList.add('weak');
          } else if (strength <= 4) {
            passwordStrengthBar.classList.add('medium');
          } else {
            passwordStrengthBar.classList.add('strong');
          }
        });
      }
      
      // Login form
      document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
          document.getElementById('errorMessage').textContent = 'Please fill all fields';
          document.getElementById('errorMessage').style.display = 'block';
          return;
        }
        
        showLoading();
        
        try {
          await signInWithEmailAndPassword(auth, email, password);
          hideLoading();
        } catch (error) {
          console.error('Login error:', error);
          hideLoading();
          
          let errorMessage = 'Invalid email or password';
          if (error.code === 'auth/user-not-found') {
            errorMessage = 'User not found';
          } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'Wrong password';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Invalid email format';
          }
          
          document.getElementById('errorMessage').textContent = errorMessage;
          document.getElementById('errorMessage').style.display = 'block';
          document.getElementById('successMessage').style.display = 'none';
          
          setTimeout(() => {
            document.getElementById('errorMessage').style.display = 'none';
          }, 3000);
        }
      });
      
      // Register form
      document.getElementById('registerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const username = document.getElementById('usernameReg').value;
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const phone = document.getElementById('phone').value;
        const nickname = document.getElementById('nickname').value || firstName;
        
        // Validation
        if (!firstName || !lastName || !username || !email || !password || !confirmPassword) {
          document.getElementById('registerErrorMessage').textContent = 'Please fill all required fields.';
          document.getElementById('registerErrorMessage').style.display = 'block';
          document.getElementById('registerSuccessMessage').style.display = 'none';
          return;
        }
        
        if (username.length < 3) {
          document.getElementById('registerErrorMessage').textContent = 'Username must be at least 3 characters.';
          document.getElementById('registerErrorMessage').style.display = 'block';
          return;
        }
        
        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
          document.getElementById('registerErrorMessage').textContent = 'Username can only contain letters, numbers, and underscore.';
          document.getElementById('registerErrorMessage').style.display = 'block';
          return;
        }
        
        if (password !== confirmPassword) {
          document.getElementById('registerErrorMessage').textContent = 'Passwords do not match.';
          document.getElementById('registerErrorMessage').style.display = 'block';
          return;
        }
        
        if (password.length < 6) {
          document.getElementById('registerErrorMessage').textContent = 'Password must be at least 6 characters.';
          document.getElementById('registerErrorMessage').style.display = 'block';
          return;
        }
        
        showLoading();
        
        try {
          // Create user with Firebase Authentication
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          
          // Update user profile
          await updateProfile(userCredential.user, {
            displayName: `${firstName} ${lastName}`
          });
          
          // Create user data in database
          const userData = {
            uid: userCredential.user.uid,
            email: email,
            username: username,
            name: `${firstName} ${lastName}`,
            nickname: nickname,
            phone: phone || '',
            role: 'member',
            status: 'active',
            avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(`${firstName} ${lastName}`)}&background=1877f2&color=fff&size=128`,
            createdAt: new Date().toISOString(),
            lastLogin: new Date().toISOString()
          };
          
          await set(ref(database, 'users/' + userCredential.user.uid), userData);
          
          // Show success message
          document.getElementById('registerSuccessMessage').style.display = 'block';
          document.getElementById('registerErrorMessage').style.display = 'none';
          document.getElementById('registerSuccessMessage').textContent = 'Registration successful! Please login.';
          
          // Clear form
          document.getElementById('registerForm').reset();
          
          // Auto switch to login after 2 seconds
          setTimeout(() => {
            showLoginForm();
            document.getElementById('username').value = email;
            document.getElementById('successMessage').textContent = 'Registration successful! Please login with your new account.';
            document.getElementById('successMessage').style.display = 'block';
          }, 2000);
          
        } catch (error) {
          console.error('Registration error:', error);
          
          let errorMessage = 'Registration failed';
          if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'Email already registered';
          } else if (error.code === 'auth/weak-password') {
            errorMessage = 'Password is too weak';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Invalid email format';
          }
          
          document.getElementById('registerErrorMessage').textContent = errorMessage;
          document.getElementById('registerErrorMessage').style.display = 'block';
          document.getElementById('registerSuccessMessage').style.display = 'none';
        } finally {
          hideLoading();
        }
      });
    });

    // ============= EXPOSE FUNCTIONS TO WINDOW =============
    window.navigateTo = navigateTo;
    window.viewProductDetail = viewProductDetail;
    window.messageSeller = messageSeller;
    window.buyProduct = buyProduct;
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.likeProduct = likeProduct;
    window.changeMainImage = changeMainImage;
    window.removeImage = removeImage;
    window.filterProducts = filterProducts;
    
    // Admin functions
    window.blockUser = blockUser;
    window.unblockUser = unblockUser;
    window.promoteToAdmin = promoteToAdmin;
    window.deleteUserAdmin = deleteUserAdmin;
    window.blockProduct = blockProduct;
    window.unblockProduct = unblockProduct;
    window.deleteProductAdmin = deleteProductAdmin;
    
    // UI functions
    window.showConfirmation = showConfirmation;
    window.showLoginForm = showLoginForm;
    window.showRegisterForm = showRegisterForm;
  </script>
</body>
</html>